name: e2e flow for call automation server client deployment...
concurrency: call-automation-sample

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:

  # Lint the Bicep file.
  lint:
    uses: ./.github/workflows/lint.yml

  # Build the server app
  build-server:
    uses: ./.github/workflows/build-server.yml

  # Build the client app
  build-client:
    uses: ./.github/workflows/build-client.yml


  # Deploy to the test server environment.
  test-server-deployment:
    uses: ./.github/workflows/deployment-server.yml
    needs:
      - lint
      - build-server
    with:
      environmentType: Test
      appUrl: https://callautomation.azurewebsites.net
    secrets:
      APP_PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_HEROSAMPLE_PUBLISH_PROFILE }}

  # Deploy to the test client environment.
  test-client-deployment:
    uses: ./.github/workflows/deployment-client.yml
    needs:
      - lint
      - build-client
    with:
      environmentType: Test
      appUrl: https://callautomation.azurewebsites.net
    secrets:
      APP_PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_HEROSAMPLE_PUBLISH_PROFILE }}

  # Deploy to the production server environment.
  production-server-deployment:
    uses: ./.github/workflows/deployment-server.yml
    needs: [test-server-deployment]
    with:
      environmentType: Production
      appUrl: https://callautomation.azurewebsites.net
    secrets:
      APP_PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_HEROSAMPLE_PUBLISH_PROFILE }}

  # Deploy to the production client environment.
  production-client-deployment:
    uses: ./.github/workflows/deployment-client.yml
    needs: [test-client-deployment]
    with:
      environmentType: Production
      appUrl: https://callautomation.azurewebsites.net
    secrets:
      APP_PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_HEROSAMPLE_PUBLISH_PROFILE }}