name: e2e flow for call automation server client deployment...
concurrency: call-automation-sample

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOTNET_VERSION: 7.0.x
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET Core SDK ${{env.DOTNET_VERSION}}
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{env.DOTNET_VERSION}}
      - name: Install dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --configuration Release --no-restore
      - name: Test
        run: dotnet test --no-restore --verbosity normal
  # Lint the Bicep file.
  lint:
    uses: ./.github/workflows/lint.yml

  # Build the server app
  build-server:
    uses: ./.github/workflows/build-server.yml

  # Build the client app
  build-client:
    uses: ./.github/workflows/build-client.yml


  # Deploy to the test environment.
  test-deployment:
    uses: ./.github/workflows/deployment.yml
    needs:
      - lint
      - build-server
      - build-client
    with:
      environmentType: Test
      resourceGroupName: TestWeb
      reviewApiUrl: https://call-automation-sample-test.azurewebsites.net/api
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_TEST }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      reviewApiKey: ${{ secrets.REVIEW_API_KEY_TEST }}

  # Deploy to the production environment.
  production-deployment:
    uses: ./.github/workflows/deployment.yml
    needs: test-deployment
    with:
      environmentType: Production
      resourceGroupName: ProductionWeb
      reviewApiUrl: https://call-automation-sample.azurewebsites.net/api
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_PRODUCTION }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      reviewApiKey: ${{ secrets.REVIEW_API_KEY_PRODUCTION }}
